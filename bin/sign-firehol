#!/bin/sh

set -e
 
dir=`pwd`

tmpdir=`mktemp -d`
trap on_exit EXIT
on_exit() {
  cd $HOME
  rm -rf $tmpdir
  return 0
}

if [ $# -ne 2 ]
then
  echo "Usage: sign-version tag signer"
  exit 1
fi

cd $tmpdir

git clone --single-branch --branch v"$1" "https://github.com/firehol/firehol.git" firehol

cd firehol
git tag -v v"$1"

sed -i -e '/GIT_REF=/d' sbin/*.in

baseurl=http://firehol.org/download/firehol/unsigned
for ext in gz bz2 xz
do
  wget -q $baseurl/v"$1"/firehol-"$1".tar.$ext
  wget -q $baseurl/v"$1"/firehol-"$1".tar.$ext.md5
  wget -q $baseurl/v"$1"/firehol-"$1".tar.$ext.sha
  md5sum -c firehol-"$1".tar.$ext.md5
  sha512sum -c firehol-"$1".tar.$ext.sha
  if [ "$ext" = "xz" ]
  then
    opts="xfJ"
  elif [ "$ext" = "bz2" ]
  then
    opts="xfj"
  elif [ "$ext" = "gz" ]
  then
    opts="xfz"
  else
    echo "Unrecognised extension $ext"
    exit 1
  fi
  tar "$opts" firehol-"$1".tar.$ext firehol-"$1"/sbin
  sed -i -e '/GIT_REF=/d' firehol-"$1"/sbin/*.in
  for i in sbin/*.in
  do
    if ! cmp $i firehol-"$1"/$i
    then
      diff $i firehol-"$1"/$i
      error=Y
    fi
  done
  rm -rf firehol-"$1"
done

if [ "$error" ]
then
  exit 1
fi

for ext in gz bz2 xz
do
  echo "Signing firehol-$1.tar.$ext"
  gpg --local-user "$2" --armor --detach-sign firehol-"$1".tar.$ext
done

cd $dir
mv $tmpdir/firehol/*.asc .

prerel=false
case "$1" in
  *-*)
    prerel=true
  ;;
esac

cat > "firehol-$1.json" <<!
{
  "tag_name": "v$1",
  "name": "v$1",
  "body": "firehol $1 - download release tarfiles from http://firehol.org/download/firehol/releases/v$1",
  "draft": false,
  "prerelease": $prerel
}
!

url=https://api.github.com/repos/firehol/firehol/releases
echo "Once the release is complete, create a github release with:"
echo "  curl -i -u username -H 'X-GitHub-OTP: 000000' -d '@firehol-$1.json' $url"
